name: Provision Lab

on:
  workflow_dispatch:
    inputs:
      azure_rg:
        description: 'Azure Resource Group'
        required: true
        type: string
        default: 'enterprise-lab'
      azure_location:
        description: 'Azure Location'
        required: true
        type: string
        default: 'germanywestcentral'
      namingPrefix:
        description: 'Naming Prefix for resources'
        required: true
        type: string
        default: 'entrlab'

env:
  AZURE_RG: ${{ inputs.azure_rg }}
  AZURE_LOCATION: ${{ inputs.azure_location }}
  NAMING_PREFIX: ${{ inputs.namingPrefix }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log into Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Encode ISO Downloads JSON to base64
    - name: Encode ISO Downloads JSON
      id: encode_json
      run: |
        echo "ISO_DOWNLOADS_BASE64=$(echo -n '${{ secrets.ISO_DOWNLOADS_JSON }}' | base64 -w 0)" >> $GITHUB_OUTPUT

    - name: Create Resource Group
      run: |
        az group create \
          --name "${{ env.AZURE_RG }}" \
          --location "${{ env.AZURE_LOCATION }}"

    - name: Deploy Bicep template
      id: deploy
      uses: azure/arm-deploy@v2
      with:
        resourceGroupName: ${{ env.AZURE_RG }}
        template: ./bicep/main.bicep
        parameters: >
          location=${{ env.AZURE_LOCATION }}
          namingPrefix=${{ env.NAMING_PREFIX }}
          windowsAdminUsername=${{ secrets.WINDOWS_ADMIN_USERNAME }}
          windowsAdminPassword=${{ secrets.WINDOWS_ADMIN_PASSWORD }}
          artifactsBaseUrl="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/"
          isoDownloadsBase64Json="${{ steps.encode_json.outputs.ISO_DOWNLOADS_BASE64 }}"
        failOnStdErr: false
        deploymentMode: Incremental

    - name: Deployment Summary
      if: always()
      run: |
        echo "### Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** ${{ env.AZURE_RG }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Location:** ${{ env.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Naming Prefix:** ${{ env.NAMING_PREFIX }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deploy.outcome }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ Deployment failed" >> $GITHUB_STEP_SUMMARY
        fi
