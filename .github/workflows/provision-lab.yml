name: Provision Lab
on:
  workflow_dispatch:
    inputs:
      azure_rg:
        description: 'Azure Resource Group'
        required: true
        type: string
        default: 'enterprise-lab'
      azure_location:
        description: 'Azure Location'
        required: true
        type: string
        default: 'germanywestcentral'
      namingPrefix:
        description: 'Naming Prefix for resources'
        required: true
        type: string
        default: 'entrlab'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

    # Checkout code
    - uses: actions/checkout@main

    # Log into Azure
    - uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Create Resource Group
    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ inputs.azure_rg }} \
          --location ${{ inputs.azure_location }}

    # Read Bootstrap Script
    - name: Read Bootstrap Script
      id: bootstrap
      run: |
        SCRIPT_CONTENT=$(cat Bootstrap.ps1)
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$SCRIPT_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # Deploy Bicep Template
    - name: Deploy Bicep file
      uses: azure/arm-deploy@v1
      with:
        resourceGroupName: ${{ inputs.azure_rg }}
        template: ./main.bicep
        parameters: location=${{ inputs.azure_location }} namingPrefix=${{ inputs.namingPrefix }} windowsAdminUsername=${{ secrets.WINDOWS_ADMIN_USERNAME }} windowsAdminPassword=${{ secrets.WINDOWS_ADMIN_PASSWORD }} bootstrapScriptContent=${{ steps.bootstrap.outputs.content }}
        failOnStdErr: true
